stages:
  - setup
  - build
  - deploy

setup_job:
  stage: setup
  script:
    - npm config set strict-ssl false
    - npm config set registry "http://registry.npm.taobao.org/"
    - npm install
  cache:
    key: ${CI_BUILD_REF_NAME}
    paths:
      - node_modules/
  artifacts:
    when: always
    paths:
      - node_modules/*
    expire_in: "1 month"
  tags:
    - test

build_job:
  stage: build
  script:
    - npm run build
  artifacts:
    when: always
    paths:
      - build/*
    expire_in: "1 month"
  tags:
    - test

deploy_to_67_job:
  stage: deploy
  script:
    - proj_path="/home/ump/UMP/$CI_BUILD_REF_NAME/ump"
    - function at_67 { ssh ump@10.0.15.67 $1; }
    - at_67 "mkdir -p ${proj_path}-manager/build ${proj_path}-manager/node_modules"
    - scp -r build/* ump@10.0.15.67:"${proj_path}-manager/build"
    - scp -r node_modules/* ump@10.0.15.67:"${proj_path}-manager/node_modules"
    - at_67 "sed -i -re \"s/(^\s*config\.host)\s*=.*/\1='api\.szdev\.cn\/'/\" ${proj_path}-manager/build/config_master.js"
    - at_67 "killall -q node; nohup node ${proj_path}-manager/build/server.js >/dev/null 2>&1 &"

  environment:
    name: test
  tags:
    - test
  only:
    - master
